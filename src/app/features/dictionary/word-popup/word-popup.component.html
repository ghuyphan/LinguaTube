<app-bottom-sheet [isOpen]="isVisible()" [showDragHandle]="true" [showCloseButton]="true" [navPadding]="true"
    (closed)="onSheetClosed()">
    <div class="popup-content">

        <div class="popup-header">
            <h2 class="popup-word" [class]="'text-' + settings.settings().language">
                {{ selectedWord()?.surface }}
            </h2>

            <div class="header-meta">
                @if (entry()?.reading) {
                <span class="popup-reading">{{ entry()?.reading }}</span>
                }
                @if (entry()?.pinyin) {
                <span class="popup-pinyin">{{ entry()?.pinyin }}</span>
                }
                @if (entry()?.romanization) {
                <span class="popup-pinyin">{{ entry()?.romanization }}</span>
                }
            </div>

            <!-- Language Target Selector (for translation) -->
            <div class="translation-controls">
                <button class="lang-select-btn" (click)="langPickerOpen.set(true)">
                    <span class="lang-flag">{{ getSelectedLangFlag() }}</span>
                    <app-icon name="chevron-down" [size]="12" />
                </button>
            </div>
        </div>

        <div class="popup-body">
            @if (dictionary.isLoading()) {
            <div class="popup-loading">
                <app-icon name="loader" [size]="20" />
                <span>{{ i18n.t('popup.lookingUp') }}</span>
            </div>
            } @else if (entry()) {
            <div class="popup-badges">
                @if (entry()?.jlptLevel) {
                <span class="badge">{{ entry()?.jlptLevel }}</span>
                }
                @if (entry()?.hskLevel) {
                <span class="badge">HSK {{ entry()?.hskLevel }}</span>
                }
                @if (entry()?.topikLevel) {
                <span class="badge">TOPIK {{ entry()?.topikLevel }}</span>
                }
            </div>

            <div class="popup-meanings">
                @for (meaning of entry()?.meanings; track $index) {
                <div class="meaning-item">
                    <span class="meaning-num">{{ $index + 1 }}</span>
                    <div class="meaning-content">
                        <div class="meaning-row">
                            <span class="meaning-text">{{ meaning.definition }}</span>

                            <!-- Translate Button -->
                            <button class="translate-btn" (click)="translateDefinition($index, meaning.definition)"
                                [disabled]="isTranslating($index)" title="Translate to {{ targetLang() }}">
                                @if (isTranslating($index)) {
                                <app-icon name="loader" [size]="14" />
                                } @else {
                                <app-icon name="languages" [size]="14" />
                                }
                            </button>
                        </div>

                        <!-- Translated Text -->
                        @if (getTranslation($index); as translatedText) {
                        <div class="translation-result">
                            <span class="translation-flag">{{ getFlag(getTranslationLang($index)) }}</span>
                            <span>{{ translatedText }}</span>
                        </div>
                        }

                        @if (meaning.tags && meaning.tags.length > 0) {
                        <div class="meaning-tags">
                            @for (tag of meaning.tags; track tag) {
                            <span class="tag">{{ tag }}</span>
                            }
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
            } @else {
            <div class="empty-state">
                <div class="empty-state__icon-box">
                    <app-icon name="info" [size]="20" />
                </div>
                <div class="empty-state__text">
                    <p class="empty-state__title">{{ i18n.t('popup.noDictionaryEntry') }}</p>
                    <p class="empty-state__description">{{ i18n.t('popup.saveManually') }}</p>
                </div>
            </div>
            }
        </div>

        <div class="popup-footer">
            @if (isSaved()) {
            <button class="btn btn-secondary saved-btn" disabled>
                <app-icon name="check" [size]="14" />
                {{ i18n.t('popup.saved') }}
            </button>
            <button class="level-select-btn" [class]="'level--' + currentLevel()" (click)="levelPickerOpen.set(true)">
                <span class="level-dot"></span>
                <span class="level-text">{{ i18n.t('vocab.' + currentLevel()) }}</span>
                <app-icon name="chevron-down" [size]="12" />
            </button>
            } @else {
            <button class="btn btn-primary" (click)="saveWord()" [disabled]="dictionary.isLoading()">
                <app-icon name="plus" [size]="14" />
                {{ i18n.t('popup.saveWord') }}
            </button>
            }

        </div>
    </div>
</app-bottom-sheet>

<!-- Language Picker -->
<app-option-picker [options]="langOptions()" [value]="targetLang()" [isOpen]="langPickerOpen()"
    [title]="i18n.t('popup.translationLang')" [navPadding]="true" (selected)="onLangSelected($event)"
    (closed)="langPickerOpen.set(false)" />

<!-- Level Picker -->
<app-option-picker [options]="levelOptions()" [value]="currentLevel()" [isOpen]="levelPickerOpen()"
    [title]="i18n.t('vocab.changeLevel')" [navPadding]="true" (selected)="onLevelSelected($event)"
    (closed)="levelPickerOpen.set(false)" />