<div class="subtitle-panel" [class.is-ai-mode]="transcript.isGeneratingAI()">
    @if (!isVideoFullscreen()) {
    <!-- Current subtitle -->
    <div class="current-subtitle" [class.current-subtitle--small]="settings.settings().fontSize === 'small'"
        [class.current-subtitle--large]="settings.settings().fontSize === 'large'"
        [class.is-generating]="transcript.isGeneratingAI()" [class.has-scroll-top]="hasScrollTop()">
        <div class="current-subtitle__inner" #currentSubtitleInner (scroll)="onCurrentSubtitleScroll()">
            @if (subtitles.currentCue(); as cue) {
            <!-- Centering wrapper - enables vertical centering for short content -->
            <div class="subtitle-center-wrapper">
                <div class="subtitle-text" [ngClass]="'text-' + settings.settings().language"
                    [class.is-looping]="isLoopEnabled()">
                    @if (currentTokens().length === 0) {
                    <!-- Shimmer skeleton while tokens load -->
                    <span class="token-loading">
                        @for (i of [1,2,3,4,5]; track $index) {
                        <span class="token-shimmer"></span>
                        }
                    </span>
                    } @else {
                    <span class="subtitle-content" @subtitleFade>
                        @for (token of currentTokens(); track $index) {@if (token.isPunctuation) {<span
                            class="punctuation">{{ token.surface }}</span>} @else {<span class="word"
                            [class.word--new]="token.level === 'new'"
                            [class.word--learning]="token.level === 'learning'"
                            [class.word--known]="token.level === 'known'"
                            [class.word--saved]="vocab.hasWord(token.surface)"
                            [class.word--grammar]="isGrammarToken($index)"
                            (click)="isGrammarToken($index) ? onGrammarClick($index, $event) : onWordClick(token, cue.text)">@if
                            (showReading() && getReading(token)) {<ruby>{{ token.surface }}<rt>{{ getReading(token) }}
                                </rt>
                            </ruby>} @else {{{ token.surface }}}</span>}}
                    </span>
                    }

                </div>

                @if (cueTranslations().get(cue.id); as translation) {
                <div class="subtitle-translation" @subtitleFade>
                    {{ translation }}
                </div>
                }
            </div>
            } @else {
            <div class="subtitle-empty">
                <div class="state-container"
                    [class.state--generating]="youtube.currentVideo() && transcript.isGeneratingAI()"
                    [class.state--loading]="youtube.currentVideo() && transcript.isLoading() && !transcript.isGeneratingAI()"
                    [class.state--error]="transcript.error() && subtitles.subtitles().length === 0 && !transcript.isLoading() && !transcript.isGeneratingAI()"
                    [class.state--empty]="!youtube.currentVideo() && subtitles.subtitles().length === 0"
                    [class.state--waiting]="youtube.currentVideo() && !transcript.isLoading() && !transcript.isGeneratingAI() && !transcript.error() && subtitles.subtitles().length > 0">

                    <!-- AI Generating -->
                    <div class="state-item state-generating">
                        <div class="ai-spinner">
                            <div class="ai-spinner-ring"></div>
                            <app-icon name="wand" [size]="18" class="ai-wand" />
                        </div>
                        <div class="ai-text">
                            <span class="ai-title">{{ transcript.isResumingPendingJob() ?
                                i18n.t('subtitle.resumingTranscript') :
                                i18n.t('subtitle.generatingTranscript') }}</span>
                            <span class="ai-hint">{{ transcript.isResumingPendingJob() ? i18n.t('subtitle.resumingHint')
                                :
                                i18n.t('subtitle.usingWhisperAI') }}</span>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div class="state-item state-loading">
                        <app-icon name="loader" [size]="24" class="loading-icon" />
                        <span class="loading-text">{{ i18n.t('subtitle.fetchingCaptions') }}</span>
                    </div>

                    <!-- Error -->
                    <div class="state-item state-error">
                        <app-icon name="alert-circle" [size]="24" class="error-icon" />
                        <div class="error-text">
                            @if (transcript.error() === 'VIDEO_TOO_LONG') {
                            <span class="empty-title">{{ i18n.t('subtitle.videoTooLongTitle') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.videoTooLongHint') }}</span>
                            } @else if (transcript.error() === 'UNSUPPORTED_LANGUAGE' || transcript.error() ===
                            'UNSUPPORTED_VIDEO_LANGUAGE') {
                            <span class="empty-title">{{ i18n.t('subtitle.unsupportedLanguageTitle') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.unsupportedLanguageHint') }}</span>
                            } @else {
                            <span class="empty-title">{{ i18n.t('subtitle.noSubtitlesAvailable') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.aiUnavailable') }}</span>
                            }
                        </div>
                    </div>

                    <!-- Empty (no video) -->
                    <div class="state-item state-empty">
                        <app-icon name="subtitles" [size]="24" class="empty-icon" />
                        <div class="empty-text">
                            <span class="empty-title">{{ i18n.t('subtitle.noSubtitlesLoaded') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.tryVideoWithCaptions') }}</span>
                        </div>
                    </div>

                    <!-- Waiting -->
                    <div class="state-item state-waiting">
                        <span class="subtitle-waiting">{{ i18n.t('subtitle.waitingForSubtitles') }}</span>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>

    <!-- Subtitle list (scrollable) -->
    @if (subtitles.subtitles().length > 0) {
    <div class="subtitle-list" #subtitleList>
        @for (cue of subtitles.subtitles(); track cue.id) {
        <button class="cue-item" [class.cue-item--active]="cue.id === subtitles.currentCue()?.id"
            [class.cue-item--past]="cue.endTime < youtube.currentTime()" [attr.data-cue-id]="cue.id"
            (click)="seekToCue(cue)">
            <span class="cue-time">{{ formatTime(cue.startTime) }}</span>
            <span class="cue-text">{{ cue.text }}</span>
        </button>
        }
    </div>
    }

    <!-- Controls -->
    <div class="subtitle-controls">
        <!-- Loop Toggle -->
        <button class="toggle-btn" [class.active]="isLoopEnabled()" (click)="toggleLoop()"
            [title]="i18n.t('subtitle.loop') + ' (L)'">
            <app-icon name="repeat" [size]="16" />
            <span>{{ i18n.t('subtitle.loop') }}</span>
            @if (isLoopEnabled() && loopCount() > 0) {
            <span class="toggle-btn__badge">{{ loopCount() }}/{{ maxLoops() }}</span>
            }
        </button>

        <!-- Dual Subtitles Toggle (Experimental) -->
        @if (effectiveLanguage() === 'ja') {
        <button class="toggle-btn" [class.active]="settings.settings().showDualSubtitles"
            (click)="settings.toggleDualSubtitles()" [title]="'Dual Subtitles (Experimental)'">
            <app-icon name="languages" [size]="16" />
            <span>EN</span>
        </button>
        }

        <!-- Reading Toggle -->
        <button class="toggle-btn" [class.active]="showReading()" (click)="toggleReading()"
            [title]="'Toggle ' + readingLabel()">
            <app-icon name="type" [size]="16" />
            <span>{{ readingLabel() }}</span>
        </button>

        <button class="toggle-btn added-btn" (click)="toggleAddedSheet()" [title]="i18n.t('nav.added')">
            <app-icon name="bookmark-plus" [size]="16" />
            @if (recentCount() > 0) {
            <span class="toggle-btn__badge">{{ recentCount() }}</span>
            }
        </button>

        <!-- Grammar Mode Toggle -->
        <button class="toggle-btn" [class.active]="grammar.grammarModeEnabled()" (click)="toggleGrammarMode()"
            [title]="i18n.t('grammar.mode')">
            <app-icon name="book-open" [size]="16" />
            <span>{{ i18n.t('grammar.mode') }}</span>
        </button>

        <div class="font-controls">
            <button class="font-btn" [class.active]="settings.settings().fontSize === 'small'"
                (click)="settings.setFontSize('small')" [title]="i18n.t('subtitle.smallFont')">A</button>
            <button class="font-btn font-btn--medium" [class.active]="settings.settings().fontSize === 'medium'"
                (click)="settings.setFontSize('medium')" [title]="i18n.t('subtitle.mediumFont')">A</button>
            <button class="font-btn font-btn--large" [class.active]="settings.settings().fontSize === 'large'"
                (click)="settings.setFontSize('large')" [title]="i18n.t('subtitle.largeFont')">A</button>
        </div>
    </div>
    }
</div>

<!-- Vocabulary Quick View Sheet -->
<app-vocabulary-quick-view [isOpen]="showAddedSheet()" (closed)="showAddedSheet.set(false)" />

<!-- Grammar Popup -->
<app-grammar-popup [pattern]="selectedGrammarPattern()" [isOpen]="grammarPopupOpen()" (closed)="closeGrammarPopup()" />