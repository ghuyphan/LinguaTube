<div class="subtitle-panel" [class.is-ai-mode]="transcript.isGeneratingAI()">
    @if (!isVideoFullscreen()) {
    <!-- Current subtitle -->
    <div class="current-subtitle" [class.current-subtitle--small]="settings.settings().fontSize === 'small'"
        [class.current-subtitle--large]="settings.settings().fontSize === 'large'"
        [class.is-generating]="transcript.isGeneratingAI()" [class.has-scroll-top]="hasScrollTop()"
        [class.has-dual-subtitles]="settings.settings().showDualSubtitles && effectiveLanguage() === 'ja'">
        <div class="current-subtitle__inner" #currentSubtitleInner (scroll)="onCurrentSubtitleScroll()">
            @if (subtitles.currentCue(); as cue) {
            <!-- Centering wrapper - enables vertical centering for short content -->
            <div class="subtitle-center-wrapper">
                <div class="subtitle-text" [ngClass]="'text-' + settings.settings().language"
                    [class.is-looping]="isLoopEnabled()">
                    @if (currentTokens().length === 0) {
                    <!-- Shimmer skeleton while tokens load -->
                    <span class="token-loading">
                        @for (i of [1,2,3,4,5]; track $index) {
                        <span class="token-shimmer"></span>
                        }
                    </span>
                    } @else {
                    <span class="subtitle-content" @subtitleFade>
                        @for (token of currentTokens(); track $index) {@if (token.isPunctuation) {<span
                            class="punctuation">{{ token.surface }}</span>} @else {<span class="word"
                            [class.word--new]="token.level === 'new'"
                            [class.word--learning]="token.level === 'learning'"
                            [class.word--known]="token.level === 'known'"
                            [class.word--saved]="vocab.hasWord(token.surface)"
                            [class.word--grammar]="isGrammarToken($index)"
                            (click)="isGrammarToken($index) ? onGrammarClick($index, $event) : onWordClick(token, cue.text)">@if
                            (showReading() && getReading(token)) {<ruby>{{ token.surface }}<rt>{{ getReading(token) }}
                                </rt>
                            </ruby>} @else {{{ token.surface }}}</span>}}
                    </span>
                    }

                </div>

                @if (cueTranslations().get(cue.id); as translation) {
                <div class="subtitle-translation" @subtitleFade>
                    {{ translation }}
                </div>
                }
            </div>
            } @else {
            <div class="subtitle-empty">
                <div class="state-container"
                    [class.state--generating]="youtube.currentVideo() && transcript.isGeneratingAI()"
                    [class.state--loading]="youtube.currentVideo() && transcript.isLoading() && !transcript.isGeneratingAI()"
                    [class.state--error]="transcript.error() && subtitles.subtitles().length === 0 && !transcript.isLoading() && !transcript.isGeneratingAI()"
                    [class.state--empty]="!youtube.currentVideo() && subtitles.subtitles().length === 0"
                    [class.state--waiting]="youtube.currentVideo() && !transcript.isLoading() && !transcript.isGeneratingAI() && !transcript.error() && subtitles.subtitles().length > 0">

                    <!-- AI Generating -->
                    <div class="state-item state-generating">
                        <div class="ai-spinner">
                            <div class="ai-spinner-ring"></div>
                            <app-icon name="wand" [size]="18" class="ai-wand" />
                        </div>
                        <div class="ai-text">
                            <span class="ai-title">{{ transcript.isResumingPendingJob() ?
                                i18n.t('subtitle.resumingTranscript') :
                                i18n.t('subtitle.generatingTranscript') }}</span>
                            <span class="ai-hint">{{ transcript.isResumingPendingJob() ? i18n.t('subtitle.resumingHint')
                                :
                                i18n.t('subtitle.usingWhisperAI') }}</span>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div class="state-item state-loading">
                        <div class="loading-spinner">
                            <div class="loading-spinner-ring"></div>
                            <app-icon name="subtitles" [size]="14" class="loading-icon" />
                        </div>
                        <span class="loading-text">{{ i18n.t('subtitle.fetchingCaptions') }}</span>
                    </div>

                    <!-- Error -->
                    <div class="state-item state-error">
                        <div class="error-icon-box">
                            <app-icon name="alert-circle" [size]="20" class="error-icon" />
                        </div>
                        <div class="error-text">
                            @if (transcript.error() === 'VIDEO_TOO_LONG') {
                            <span class="empty-title">{{ i18n.t('subtitle.videoTooLongTitle') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.videoTooLongHint') }}</span>
                            } @else if (transcript.error() === 'UNSUPPORTED_LANGUAGE' || transcript.error() ===
                            'UNSUPPORTED_VIDEO_LANGUAGE') {
                            <span class="empty-title">{{ i18n.t('subtitle.unsupportedLanguageTitle') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.unsupportedLanguageHint') }}</span>
                            } @else if (transcript.error() === 'RATE_LIMITED') {
                            <span class="empty-title">{{ i18n.t('subtitle.rateLimitedTitle') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.rateLimitedHint') }}</span>
                            } @else if (transcript.error() === 'NETWORK_ERROR') {
                            <span class="empty-title">{{ i18n.t('subtitle.networkErrorTitle') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.networkErrorHint') }}</span>
                            } @else if (transcript.error() === 'SERVER_ERROR') {
                            <span class="empty-title">{{ i18n.t('subtitle.serverErrorTitle') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.serverErrorHint') }}</span>
                            } @else if (transcript.error() === 'NO_NATIVE' && transcript.diamonds() > 0) {
                            <!-- No native captions but AI available -->
                            <span class="empty-title">{{ i18n.t('subtitle.noCaptionsAvailable') }}</span>
                            <button class="try-ai-btn" (click)="manualAITrigger.emit()">
                                <app-icon name="diamond" [size]="16" />
                                <span>{{ i18n.t('subtitle.useAITranscription') }}</span>
                                <span class="diamond-count">({{ transcript.diamonds() }}/{{ transcript.maxDiamonds()
                                    }})</span>
                            </button>
                            } @else if (transcript.error() === 'NO_DIAMONDS') {
                            <span class="empty-title">{{ i18n.t('subtitle.noCaptionsAvailable') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.noDiamondsLeft') }}</span>
                            } @else {
                            <span class="empty-title">{{ i18n.t('subtitle.noSubtitlesAvailable') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.aiUnavailable') }}</span>
                            }
                        </div>
                    </div>

                    <!-- Empty (no video) -->
                    <div class="state-item state-empty">
                        <div class="empty-icon-box">
                            <app-icon name="subtitles" [size]="20" class="empty-icon" />
                        </div>
                        <div class="empty-text">
                            <span class="empty-title">{{ i18n.t('subtitle.noSubtitlesLoaded') }}</span>
                            <span class="empty-hint">{{ i18n.t('subtitle.tryVideoWithCaptions') }}</span>
                        </div>
                    </div>

                    <!-- Waiting -->
                    <div class="state-item state-waiting">
                        <div class="waiting-dots">
                            <span class="waiting-dot"></span>
                            <span class="waiting-dot"></span>
                            <span class="waiting-dot"></span>
                        </div>
                        <span class="subtitle-waiting">{{ i18n.t('subtitle.waitingForSubtitles') }}</span>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>

    <!-- Subtitle list (scrollable) -->
    @if (subtitles.subtitles().length > 0) {
    <div class="subtitle-list" #subtitleList>
        @for (cue of subtitles.subtitles(); track cue.id) {
        <button class="cue-item" [class.cue-item--active]="cue.id === subtitles.currentCue()?.id"
            [class.cue-item--past]="cue.endTime < youtube.currentTime()" [attr.data-cue-id]="cue.id"
            (click)="seekToCue(cue)">
            <span class="cue-time">{{ formatTime(cue.startTime) }}</span>
            <span class="cue-text">{{ cue.text }}</span>
        </button>
        }
    </div>
    }

    <!-- Controls -->
    <div class="subtitle-controls" #subtitleControls>
        <!-- Primary controls - always visible -->
        <button class="ctrl-btn" [class.active]="isLoopEnabled()" (click)="toggleLoop()"
            [title]="i18n.t('subtitle.loop') + ' (L)'">
            <app-icon name="repeat" [size]="16" />
            <span class="ctrl-label">{{ i18n.t('subtitle.loop') }}</span>
            @if (isLoopEnabled() && loopCount() > 0) {
            <span class="ctrl-badge">{{ loopCount() }}/{{ maxLoops() }}</span>
            }
        </button>

        <button class="ctrl-btn" [class.active]="showReading()" (click)="toggleReading()"
            [title]="'Toggle ' + readingLabel()">
            <app-icon name="type" [size]="16" />
            <span class="ctrl-label">{{ readingLabel() }}</span>
        </button>

        <button class="ctrl-btn" (click)="toggleAddedSheet()" [title]="i18n.t('nav.added')">
            <app-icon name="bookmark-plus" [size]="16" />
            @if (recentCount() > 0) {
            <span class="ctrl-badge">{{ recentCount() }}</span>
            }
        </button>

        <!-- Expand toggle button -->
        <button class="ctrl-btn ctrl-btn--expand" [class.active]="isControlsExpanded()"
            (click)="toggleControlsExpanded()" [title]="i18n.t('subtitle.moreOptions')">
            <app-icon name="more-horizontal" [size]="16" class="expand-icon" [class.rotated]="isControlsExpanded()" />
        </button>

        <!-- Expandable section -->
        <div class="controls-expand" [class.expanded]="isControlsExpanded()">
            <!-- Dual Subtitles Toggle -->
            @if (effectiveLanguage() === 'ja') {
            <button class="ctrl-btn" [class.active]="settings.settings().showDualSubtitles"
                (click)="settings.toggleDualSubtitles()" [title]="'Dual Subtitles'">
                <app-icon name="languages" [size]="16" />
                <span class="ctrl-label">EN</span>
            </button>
            }

            <!-- Grammar Mode Toggle -->
            <button class="ctrl-btn" [class.active]="grammar.grammarModeEnabled()" (click)="toggleGrammarMode()"
                [title]="i18n.t('grammar.mode')">
                <app-icon name="book-open" [size]="16" />
                <span class="ctrl-label">{{ i18n.t('grammar.mode') }}</span>
            </button>

            <!-- Font size controls -->
            <div class="font-controls">
                <button class="font-btn" [class.active]="settings.settings().fontSize === 'small'"
                    (click)="settings.setFontSize('small')" [title]="i18n.t('subtitle.smallFont')">A</button>
                <button class="font-btn font-btn--medium" [class.active]="settings.settings().fontSize === 'medium'"
                    (click)="settings.setFontSize('medium')" [title]="i18n.t('subtitle.mediumFont')">A</button>
                <button class="font-btn font-btn--large" [class.active]="settings.settings().fontSize === 'large'"
                    (click)="settings.setFontSize('large')" [title]="i18n.t('subtitle.largeFont')">A</button>
            </div>


        </div>
    </div>
    }
</div>

<!-- Vocabulary Quick View Sheet -->
<app-vocabulary-quick-view [isOpen]="showAddedSheet()" (closed)="showAddedSheet.set(false)" />

<!-- Grammar Popup -->
<app-grammar-popup [pattern]="selectedGrammarPattern()" [isOpen]="grammarPopupOpen()" (closed)="closeGrammarPopup()" />