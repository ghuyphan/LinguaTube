<div class="player-wrapper">
  @if (!youtube.currentVideo() && !isLoading() && !youtube.pendingVideoId()) {
  <!-- URL Input State -->
  <div class="video-input" [class.animate-enter]="stateTransition() === 'to-input'">
    <div class="input-group">
      <div class="input-wrapper input-group--icon">
        <app-icon name="search" [size]="16" class="input-icon" />
        <input type="text" [(ngModel)]="videoUrl" [placeholder]="i18n.t('player.pasteUrl')" class="url-input"
          (keyup.enter)="loadVideo()" />
        @if (videoUrl) {
        <button class="clear-btn" (click)="clearUrl()">
          <app-icon name="x" [size]="14" />
        </button>
        }
      </div>
      <button class="btn btn-primary load-btn" (click)="loadVideo()" [disabled]="isLoading()">
        @if (isLoading()) {
        <app-icon name="loader" [size]="16" />
        } @else {
        {{ i18n.t('player.load') }}
        }
      </button>
    </div>

    @if (error()) {
    <div class="error-banner">
      <app-icon name="alert-circle" [size]="16" />
      <span>{{ error() }}</span>
    </div>
    }

    <div class="hints">
      <p class="hint-text">
        <app-icon name="info" [size]="14" />
        {{ i18n.t('player.hint') }}
      </p>
    </div>
  </div>
  } @else {
  <!-- Video Loaded State -->
  <!-- Mouse handlers on container level so controls stay visible when hovering on them -->
  <div class="video-container" #videoContainer [class.is-fullscreen]="isFullscreen()"
    [class.animate-enter]="stateTransition() === 'to-video'" (mousemove)="onUserActivity()"
    (mouseleave)="onMouseLeave()">

    <div class="video-embed-ratio">
      <div id="youtube-player"></div>
    </div>

    <!-- Loading Overlay -->
    @if (youtube.pendingVideoId() && !youtube.currentVideo()) {
    <div class="loading-overlay">
      <div class="loading-indicator">
        <app-icon name="loader" [size]="32" />
      </div>
    </div>
    }

    <!-- Seek Feedback - positioned at container level -->
    <div class="seek-feedback seek-feedback--left" [class.animate]="rewindFeedback()"
      (animationend)="onSeekAnimationEnd()">
      <div class="seek-feedback-inner">
        <app-icon name="rewind" [size]="24" />
        <span class="seek-time">{{ seekAccumulator() }}</span>
      </div>
    </div>
    <div class="seek-feedback seek-feedback--right" [class.animate]="forwardFeedback()"
      (animationend)="onSeekAnimationEnd()">
      <div class="seek-feedback-inner">
        <app-icon name="fast-forward" [size]="24" />
        <span class="seek-time">{{ seekAccumulator() }}</span>
      </div>
    </div>

    <!-- Touch Overlay (mobile only) -->
    <div class="player-overlay touch-only" (touchstart)="onOverlayTouchStart($event)"
      (touchmove)="onOverlayTouchMove($event)" (touchend)="onOverlayTouchEnd($event)"
      (touchcancel)="onOverlayTouchEnd($event)">
      <div class="zone zone-left">
        @if (leftRipple()) {
        <div class="ripple-effect" [style.--x]="ripplePos().x + 'px'" [style.--y]="ripplePos().y + 'px'"></div>
        }
      </div>
      <div class="zone zone-right">
        @if (rightRipple()) {
        <div class="ripple-effect" [style.--x]="ripplePos().x + 'px'" [style.--y]="ripplePos().y + 'px'"></div>
        }

      </div>
    </div>

    <!-- Click Overlay (desktop only) - click handling only -->
    <div class="player-overlay hover-only" (click)="onOverlayClick($event)"></div>


    <!-- Center Controls -->
    <div class="center-controls">
      <!-- Volume Feedback -->
      @if (volumeFeedback()) {
      <div class="center-feedback volume-feedback animate">
        <app-icon [name]="volumeFeedbackIcon()" [size]="44" aria-hidden="true" />
      </div>
      }

      <!-- Gesture Seek Preview -->
      @if (gestureSeekActive()) {
      <div class="gesture-seek-preview">
        <span class="gesture-seek-time">{{ formatTime(gestureSeekTime()) }}</span>
        <span class="gesture-seek-delta">
          @if (gestureSeekTime() > youtube.currentTime()) {
          +{{ formatTime(gestureSeekTime() - youtube.currentTime()) }}
          } @else {
          -{{ formatTime(youtube.currentTime() - gestureSeekTime()) }}
          }
        </span>
      </div>
      }

      <!-- Big Play/Pause Button - Mobile -->
      @if (youtube.isReady() && !youtube.isEnded() && (areControlsVisible() || !youtube.isPlaying() ||
      youtube.isBuffering())) {
      @if (youtube.isBuffering()) {
      <button class="big-play-btn touch-only buffering" aria-label="Loading video"
        (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation()" disabled>
        <app-icon name="loader" [size]="44" aria-hidden="true" />
      </button>
      } @else if (!youtube.isPlaying()) {
      <button class="big-play-btn touch-only" aria-label="Play video" (touchstart)="$event.stopPropagation()"
        (touchend)="onPlayPauseButtonTouch($event)" (click)="$event.stopPropagation()">
        <app-icon name="play" [size]="44" aria-hidden="true" />
      </button>
      } @else {
      <button class="big-play-btn touch-only fade-in" aria-label="Pause video" (touchstart)="$event.stopPropagation()"
        (touchend)="onPlayPauseButtonTouch($event)" (click)="$event.stopPropagation()">
        <app-icon name="pause" [size]="44" aria-hidden="true" />
      </button>
      }
      }

      <!-- Big Play/Pause Button - Desktop -->
      @if (youtube.isReady() && !youtube.isEnded()) {
      @if (youtube.isBuffering()) {
      <button class="big-play-btn hover-only buffering" aria-label="Loading video" disabled>
        <app-icon name="loader" [size]="44" aria-hidden="true" />
      </button>
      } @else if (!youtube.isPlaying()) {
      <button class="big-play-btn hover-only" aria-label="Play video" (click)="onPlayPauseButtonClick($event)">
        <app-icon name="play" [size]="44" aria-hidden="true" />
      </button>
      } @else if (areControlsVisible()) {
      <button class="big-play-btn hover-only fade-in" aria-label="Pause video" (click)="onPlayPauseButtonClick($event)">
        <app-icon name="pause" [size]="44" aria-hidden="true" />
      </button>
      }
      }

      <!-- Replay Button -->
      @if (youtube.isEnded()) {
      <button class="big-play-btn replay-btn" aria-label="Replay video" (touchstart)="$event.stopPropagation()"
        (touchend)="onReplayClick($event)" (click)="onReplayClick($event)">
        <app-icon name="rotate-ccw" [size]="44" aria-hidden="true" />
      </button>
      }
    </div>

    <!-- Mini Progress Bar -->
    <div class="mini-progress" [class.visible]="!areControlsVisible() && youtube.isPlaying()"
      [style.--progress]="progressPercentage()" (touchstart)="startSeeking($event)" (mousedown)="startSeeking($event)">
      <div class="mini-progress__fill"></div>
    </div>


    <!-- Fullscreen Subtitle Overlay -->
    @if (isFullscreen()) {
    <div class="fullscreen-subtitle" [class.controls-visible]="areControlsVisible()" [ngClass]="fontSizeClass()"
      [class.popup-open]="fsPopupVisible()" [class.has-content]="!!subtitles.currentCue()">
      @if (subtitles.currentCue(); as cue) {
      <div class="fs-subtitle-inner">
        <div class="fs-subtitle-text" [class]="'text-' + settings.settings().language">
          @if (subtitles.isTokenizing()) {
          <span class="fs-word">{{ cue.text }}</span>
          } @else { @for (token of fullscreenTokens(); track $index) {@if (token.isPunctuation) {<span
            class="fs-word fs-word--punctuation">{{ token.surface }}</span>} @else {<button type="button"
            class="fs-word" [class.fs-word--saved]="vocab.hasWord(token.surface)"
            [class.fs-word--grammar]="isFsGrammarToken($index)" [attr.aria-label]="'Look up ' + token.surface"
            (click)="isFsGrammarToken($index) ? onFsGrammarClick($index, $event) : onFullscreenWordClick(token, cue.text, $event)">@if
            (showFsReading() &&
            getFullscreenReading(token))
            {<ruby>{{ token.surface }}<rt>{{ getFullscreenReading(token) }}</rt></ruby>} @else {{{ token.surface
            }}}</button>}} }
        </div>

        @if (settings.settings().showDualSubtitles && currentTranslation()) {
        <div class="fs-subtitle-translation">
          {{ currentTranslation() }}
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- Fullscreen Word Popup -->
    @if (isFullscreen() && fsPopupVisible()) {
    <div class="fs-popup-overlay" role="dialog" aria-modal="true" aria-labelledby="fs-popup-title"
      (click)="closeFsPopup()" (touchstart)="onPopupOverlayTouchStart($event)"
      (touchmove)="onPopupOverlayTouchMove($event)" (touchend)="onWordPopupOverlayTouchEnd($event)">
      <div class="fs-popup" (click)="$event.stopPropagation()">
        <button class="fs-popup-close" aria-label="Close popup" (click)="closeFsPopup()">
          <app-icon name="x" [size]="18" aria-hidden="true" />
        </button>

        <div class="fs-popup-header">
          <h3 class="fs-popup-word" [class]="'text-' + settings.settings().language">
            {{ fsSelectedWord()?.surface }}
          </h3>
          @if (fsEntry()?.reading) {
          <span class="fs-popup-reading">{{ fsEntry()?.reading }}</span>
          } @if (fsEntry()?.pinyin) {
          <span class="fs-popup-reading">{{ fsEntry()?.pinyin }}</span>
          } @if (fsEntry()?.romanization) {
          <span class="fs-popup-reading">{{ fsEntry()?.romanization }}</span>
          }
        </div>

        <div class="fs-popup-body">
          @if (fsLookupLoading()) {
          <div class="fs-popup-loading">
            <app-icon name="loader" [size]="20" />
          </div>
          } @else if (fsEntry()) { @if (fsEntry()?.jlptLevel || fsEntry()?.hskLevel || fsEntry()?.topikLevel) {
          <div class="fs-popup-badges">
            @if (fsEntry()?.jlptLevel) {
            <span class="badge">{{ fsEntry()?.jlptLevel }}</span>
            } @if (fsEntry()?.hskLevel) {
            <span class="badge">HSK {{ fsEntry()?.hskLevel }}</span>
            } @if (fsEntry()?.topikLevel) {
            <span class="badge">TOPIK {{ fsEntry()?.topikLevel }}</span>
            }
          </div>
          }
          <div class="fs-popup-meaning">
            {{ fsEntry()?.meanings?.[0]?.definition || '(no definition)' }}
          </div>
          } @else {
          <div class="fs-popup-meaning">{{ i18n.t('popup.noDictionaryEntry') }}</div>
          }
        </div>

        <div class="fs-popup-actions">
          @if (fsWordSaved()) {
          <button class="fs-popup-btn fs-popup-btn--saved" disabled>
            <app-icon name="check" [size]="16" />
            {{ i18n.t('popup.saved') }}
          </button>
          } @else {
          <button class="fs-popup-btn fs-popup-btn--save" (click)="saveFsWord()">
            <app-icon name="plus" [size]="16" />
            {{ i18n.t('popup.saveWord') }}
          </button>
          }
          <button class="fs-popup-btn" (click)="resumeAndClose()">
            <app-icon name="play" [size]="16" />
            Resume
          </button>
        </div>
      </div>
    </div>
    }

    <!-- Fullscreen Grammar Popup -->
    @if (isFullscreen() && fsGrammarPopupVisible()) {
    <div class="fs-popup-overlay" role="dialog" aria-modal="true" (click)="closeFsGrammarPopup()"
      (touchstart)="onPopupOverlayTouchStart($event)" (touchmove)="onPopupOverlayTouchMove($event)"
      (touchend)="onGrammarPopupOverlayTouchEnd($event)">
      <app-grammar-popup [pattern]="fsSelectedGrammarPattern()" [isOpen]="true" (closed)="closeFsGrammarPopup()" />
    </div>
    }

    <!-- Custom Controls -->
    <div class="custom-controls" [class.controls-hidden]="!areControlsVisible() && youtube.isPlaying()">
      <!-- Progress Bar -->
      <div class="progress-container" role="slider" [attr.aria-valuenow]="displayTime()" [attr.aria-valuemin]="0"
        [attr.aria-valuemax]="youtube.duration()"
        [attr.aria-valuetext]="formattedCurrentTime() + ' of ' + formattedDuration()" aria-label="Video progress"
        tabindex="0" [class.seeking]="isDragging()" (mousedown)="startSeeking($event)"
        (touchstart)="startSeeking($event)" (mousemove)="updateSeekPreview($event)" (mouseleave)="hideSeekPreview()"
        [style.--progress]="progressPercentage()" [style.--buffered]="bufferedPercentage()"
        [style.--seek-pos]="seekPreview().position + 'px'" #progressBar>
        <div class="progress-buffered" aria-hidden="true"></div>
        <div class="progress-fill" aria-hidden="true"></div>
        <div class="progress-handle" aria-hidden="true"></div>

        @if (seekPreview().visible) {
        <div class="seek-tooltip" aria-hidden="true">
          {{ formatTime(seekPreview().time) }}
        </div>
        }
      </div>


      <div class="controls-row">
        <!-- Left Controls -->
        <div class="controls-left">
          <!-- Seek buttons - desktop only -->
          <div class="seek-group desktop-only">
            <button class="control-btn" (click)="seekRelative(-10); showSeekFeedback('left', 10)"
              aria-label="Rewind 10 seconds">
              <app-icon name="rewind" [size]="18" aria-hidden="true" />
            </button>
            <button class="control-btn" (click)="seekRelative(10); showSeekFeedback('right', 10)"
              aria-label="Forward 10 seconds">
              <app-icon name="fast-forward" [size]="18" aria-hidden="true" />
            </button>
          </div>

          <!-- Volume - desktop only -->
          <div class="volume-control desktop-only" (mouseenter)="showVolumeSlider()" (mouseleave)="hideVolumeSlider()">
            <button class="control-btn" (click)="toggleMute()" aria-label="Toggle mute">
              <app-icon [name]="getVolumeIcon()" [size]="18" />
            </button>
            <div class="volume-slider-container" [class.visible]="isVolumeSliderVisible()">
              <input type="range" class="volume-slider" min="0" max="100" [value]="volume()"
                [style.--volume-percent]="volume() + '%'" (input)="onVolumeChange($event)"
                (mousedown)="$event.stopPropagation()" aria-label="Volume" />
            </div>
          </div>

          <!-- Time Display -->
          <div class="time-display">
            <span class="time-current">{{ formattedCurrentTime() }}</span>
            <span class="time-separator">/</span>
            <span class="time-total">{{ formattedDuration() }}</span>
          </div>

          <!-- Mute button - mobile only -->
          <button class="control-btn mobile-only" (click)="toggleMute()" aria-label="Toggle mute">
            <app-icon [name]="getVolumeIcon()" [size]="18" />
          </button>
        </div>

        <!-- Right Controls -->
        <div class="controls-right">
          <!-- Playback Speed - desktop only -->
          <div class="speed-control desktop-only" [class.open]="isSpeedMenuOpen()">
            <button class="control-btn speed-btn" (click)="toggleSpeedMenu($event)" aria-label="Playback speed">
              <span class="speed-label">{{ currentSpeed() }}x</span>
            </button>
            @if (isSpeedMenuOpen()) {
            <div class="speed-menu" (click)="$event.stopPropagation()">
              @for (speed of playbackSpeeds; track speed) {
              <button class="speed-option" [class.active]="currentSpeed() === speed" (click)="setPlaybackSpeed(speed)">
                {{ speed === 1 ? i18n.t('player.normal') : speed + 'x' }}
              </button>
              }
            </div>
            }
          </div>

          <!-- Font Size - fullscreen only -->
          @if (isFullscreen()) {
          <button class="control-btn font-size-btn" (click)="cycleFontSize()" aria-label="Change subtitle font size">
            <span class="font-size-label">{{ getFontSizeLabel() }}</span>
          </button>
          }

          <!-- Close - not in fullscreen -->
          @if (!isFullscreen()) {
          <button class="control-btn close-btn" (click)="closeVideo()" aria-label="Close video">
            <app-icon name="x" [size]="18" />
          </button>
          }

          <!-- Fullscreen -->
          <button class="control-btn" (click)="toggleFullscreen()"
            [attr.aria-label]="isFullscreen() ? 'Exit fullscreen' : 'Fullscreen'">
            <app-icon [name]="isFullscreen() ? 'minimize' : 'maximize'" [size]="18" />
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Video Info -->
  @if (!isFullscreen()) {
  <div class="video-info">
    @if (youtube.currentVideo(); as video) {
    <h2 class="video-title">{{ video.title }}</h2>
    <span class="video-channel">{{ video.channel }}</span>
    } @else {
    <!-- Skeleton loading with shimmer effect -->
    <div class="skeleton skeleton-title"></div>
    <div class="skeleton skeleton-channel"></div>
    }
  </div>
  }
  }
</div>