<app-bottom-sheet [isOpen]="isOpen()" [showCloseButton]="true" (closed)="closed.emit()">
    <div class="settings-sheet">
        <div class="settings-header">
            <h2>{{ i18n.t('settings.title') }}</h2>
        </div>

        <!-- User Section -->
        <div class="settings-section">
            @if (auth.isLoggedIn()) {
            <div class="user-card">
                <img [src]="auth.user()?.picture" [alt]="auth.user()?.name" class="user-avatar" />
                <div class="user-info">
                    <span class="user-name">{{ auth.user()?.name }}</span>
                    <span class="badge" [class]="'badge--' + auth.getSubscriptionTier()"
                        style="align-self: flex-start; margin-bottom: 2px;">
                        {{ auth.getSubscriptionTier() | uppercase }}
                    </span>
                    <span class="user-email">{{ auth.user()?.email }}</span>
                </div>
                <div class="sync-badge" [class.syncing]="sync.syncStatus() === 'syncing'"
                    [class.error]="sync.syncStatus() === 'error'">
                    @if (sync.syncStatus() === 'syncing') {
                    <app-icon name="loader" [size]="14" class="spin" />
                    } @else if (sync.syncStatus() === 'error') {
                    <app-icon name="alert-circle" [size]="14" />
                    } @else {
                    <app-icon name="check" [size]="14" />
                    }
                </div>
            </div>
            <button class="settings-btn settings-btn--danger" (click)="showSignOutModal()">
                <app-icon name="log-out" [size]="18" />
                {{ i18n.t('header.signOut') }}
            </button>
            } @else if (auth.isInitialized() && auth.isAuthEnabled()) {
            <button class="settings-btn settings-btn--primary" (click)="loginWithGoogle()" [disabled]="isLoggingIn">
                <app-icon name="user" [size]="18" />
                {{ i18n.t('header.signIn') }}
            </button>
            <p class="google-signin-hint">{{ i18n.t('settings.syncVocab') }}</p>
            }
        </div>

        <!-- Streak Section (Mobile Only) -->
        <div class="settings-section streak-section">
            <div class="setting-row streak-row">
                <div class="streak-icon-wrapper">
                    <app-icon name="fire" [size]="20" class="streak-icon" />
                </div>
                <div class="streak-info">
                    <span class="streak-count">{{ streak.currentStreak() }}</span>
                    <span class="streak-label">{{ i18n.t('streak.dayStreak') }}</span>
                </div>
                <div class="streak-meta">
                    <span class="streak-longest">{{ i18n.t('streak.longestStreak') }}: {{ streak.longestStreak()
                        }}</span>
                    @if (streak.freezesRemaining() > 0 && streak.currentStreak() > 0) {
                    <span class="streak-freezes-badge">
                        <app-icon name="snowflake" [size]="12" />
                        {{ streak.freezesRemaining() }}
                    </span>
                    }
                </div>
            </div>
        </div>

        <!-- Language Settings -->
        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.learningLanguage') }}</h3>
            <button class="setting-row setting-row--clickable" (click)="showLearningLangPicker.set(true)">
                <div class="setting-row__content">
                    <img [src]="currentLearningLang().flag" class="setting-row__flag" alt="" />
                    <span class="setting-row__value">{{ currentLearningLang().name }}</span>
                </div>
                <app-icon name="chevron-right" [size]="18" class="setting-row__chevron" />
            </button>
        </div>

        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.interfaceLanguage') }}</h3>
            <button class="setting-row setting-row--clickable" (click)="showUILangPicker.set(true)">
                <div class="setting-row__content">
                    <img [src]="currentUILang().flag" class="setting-row__flag" alt="" />
                    <span class="setting-row__value">{{ currentUILang().nativeName }}</span>
                </div>
                <app-icon name="chevron-right" [size]="18" class="setting-row__chevron" />
            </button>
        </div>

        <!-- Theme Toggle -->
        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.appearance') }}</h3>
            <div class="setting-row">
                <div class="setting-row__content">
                    <app-icon [name]="isDarkMode() ? 'sun' : 'moon'" [size]="20" class="setting-row__icon" />
                    <span class="setting-row__label">
                        {{ isDarkMode() ? i18n.t('settings.switchToLightMode') : i18n.t('settings.switchToDarkMode') }}
                    </span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" [checked]="isDarkMode()" (change)="toggleTheme()" />
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
</app-bottom-sheet>

<!-- Learning Language Picker -->
<app-bottom-sheet [isOpen]="showLearningLangPicker()" [showCloseButton]="true"
    (closed)="showLearningLangPicker.set(false)">
    <div class="picker-sheet">
        <h3 class="picker-title">{{ i18n.t('settings.learningLanguage') }}</h3>
        <div class="picker-options">
            @for (lang of learningLanguages; track lang.code) {
            <button class="picker-option" [class.active]="settings.settings().language === lang.code"
                (click)="setLanguage(lang.code); showLearningLangPicker.set(false)">
                <img [src]="lang.flag" class="picker-option__flag" alt="" />
                <span class="picker-option__name">{{ lang.name }}</span>
                @if (settings.settings().language === lang.code) {
                <app-icon name="check" [size]="18" class="picker-option__check" />
                }
            </button>
            }
        </div>
    </div>
</app-bottom-sheet>

<!-- UI Language Picker -->
<app-bottom-sheet [isOpen]="showUILangPicker()" [showCloseButton]="true" (closed)="showUILangPicker.set(false)">
    <div class="picker-sheet">
        <h3 class="picker-title">{{ i18n.t('settings.interfaceLanguage') }}</h3>
        <div class="picker-options">
            @for (lang of i18n.availableLanguages; track lang.code) {
            <button class="picker-option" [class.active]="i18n.currentLanguage() === lang.code"
                (click)="setUILanguage(lang.code); showUILangPicker.set(false)">
                <img [src]="lang.flag" class="picker-option__flag" alt="" />
                <span class="picker-option__name">{{ lang.nativeName }}</span>
                @if (i18n.currentLanguage() === lang.code) {
                <app-icon name="check" [size]="18" class="picker-option__check" />
                }
            </button>
            }
        </div>
    </div>
</app-bottom-sheet>

<!-- Sign Out Confirmation Modal -->
<app-bottom-sheet [isOpen]="showSignOutConfirm()" [showDragHandle]="false" (closed)="showSignOutConfirm.set(false)">
    <div class="confirm-modal">
        <div class="confirm-icon">
            <app-icon name="log-out" [size]="32" />
        </div>
        <h3 class="confirm-title">{{ i18n.t('settings.signOutConfirmTitle') }}</h3>
        <p class="confirm-message">{{ i18n.t('settings.signOutConfirmMessage') }}</p>
        <div class="confirm-actions">
            <button class="confirm-btn confirm-btn--cancel" (click)="showSignOutConfirm.set(false)">
                {{ i18n.t('vocab.cancel') }}
            </button>
            <button class="confirm-btn confirm-btn--danger" (click)="confirmSignOut()">
                {{ i18n.t('header.signOut') }}
            </button>
        </div>
    </div>
</app-bottom-sheet>