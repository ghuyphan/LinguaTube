<app-bottom-sheet [isOpen]="isOpen()" [showCloseButton]="true" (closed)="closed.emit()">
    <div class="settings-sheet">
        <div class="settings-header">
            <h2>{{ i18n.t('settings.title') }}</h2>
        </div>

        <!-- User Section -->
        <div class="settings-section">
            @if (auth.isLoggedIn()) {
            <div class="user-card">
                <img [src]="auth.user()?.picture" [alt]="auth.user()?.name" class="user-avatar" />
                <div class="user-info">
                    <span class="user-name">{{ auth.user()?.name }}</span>
                    <span class="badge" [class]="'badge--' + auth.getSubscriptionTier()"
                        style="align-self: flex-start; margin-bottom: 2px;">
                        {{ auth.getSubscriptionTier() | uppercase }}
                    </span>
                    <span class="user-email">{{ auth.user()?.email }}</span>
                </div>
                <div class="sync-badge" [class.syncing]="sync.syncStatus() === 'syncing'"
                    [class.error]="sync.syncStatus() === 'error'">
                    @if (sync.syncStatus() === 'syncing') {
                    <app-icon name="loader" [size]="14" class="spin" />
                    } @else if (sync.syncStatus() === 'error') {
                    <app-icon name="alert-circle" [size]="14" />
                    } @else {
                    <app-icon name="check" [size]="14" />
                    }
                </div>
            </div>
            <button class="settings-btn settings-btn--danger" (click)="showSignOutModal()">
                <app-icon name="log-out" [size]="18" />
                {{ i18n.t('header.signOut') }}
            </button>
            } @else if (auth.isInitialized() && auth.isAuthEnabled()) {
            <button class="settings-btn settings-btn--primary" (click)="loginWithGoogle()" [disabled]="isLoggingIn">
                <app-icon name="user" [size]="18" />
                {{ i18n.t('header.signIn') }}
            </button>
            <p class="google-signin-hint">{{ i18n.t('settings.syncVocab') }}</p>
            }
        </div>

        <!-- Streak Section -->
        <div class="settings-section streak-section">
            <div class="streak-display">
                <div class="streak-icon-wrapper">
                    <app-icon name="fire" [size]="24" class="streak-icon" />
                </div>
                <div class="streak-details">
                    <div class="streak-main">
                        <span class="streak-number">{{ streak.currentStreak() }}</span>
                        <span class="streak-text">{{ i18n.t('streak.dayStreak') }}</span>
                    </div>
                    <div class="streak-sub">
                        <span class="streak-longest">{{ i18n.t('streak.longestStreak') }}: {{ streak.longestStreak()
                            }}</span>
                        @if (streak.freezesRemaining() > 0 && streak.currentStreak() > 0) {
                        <span class="streak-freezes-badge">
                            <app-icon name="snowflake" [size]="12" />
                            {{ streak.freezesRemaining() }}
                        </span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Language Selection -->
        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.learningLanguage') }}</h3>
            <div class="lang-grid">
                <button class="lang-option" [class.active]="settings.settings().language === 'ja'"
                    (click)="setLanguage('ja')">
                    <img src="https://hatscripts.github.io/circle-flags/flags/jp.svg" class="circle-flag" alt="Japan" />
                    <span class="lang-name">日本語</span>
                </button>
                <button class="lang-option" [class.active]="settings.settings().language === 'zh'"
                    (click)="setLanguage('zh')">
                    <img src="https://hatscripts.github.io/circle-flags/flags/cn.svg" class="circle-flag" alt="China" />
                    <span class="lang-name">中文</span>
                </button>
                <button class="lang-option" [class.active]="settings.settings().language === 'ko'"
                    (click)="setLanguage('ko')">
                    <img src="https://hatscripts.github.io/circle-flags/flags/kr.svg" class="circle-flag" alt="Korea" />
                    <span class="lang-name">한국어</span>
                </button>
                <button class="lang-option" [class.active]="settings.settings().language === 'en'"
                    (click)="setLanguage('en')">
                    <img src="https://hatscripts.github.io/circle-flags/flags/gb.svg" class="circle-flag" alt="UK" />
                    <span class="lang-name">English</span>
                </button>
            </div>
        </div>

        <!-- UI Language Selection -->
        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.interfaceLanguage') }}</h3>
            <div class="lang-grid lang-grid--3col">
                @for (lang of i18n.availableLanguages; track lang.code) {
                <button class="lang-option" [class.active]="i18n.currentLanguage() === lang.code"
                    (click)="setUILanguage(lang.code)">
                    <img [src]="lang.flag" class="circle-flag" [alt]="lang.name" />
                    <span class="lang-name">{{ lang.nativeName }}</span>
                </button>
                }
            </div>
        </div>

        <!-- Theme -->
        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.appearance') }}</h3>
            <button class="settings-btn" (click)="toggleTheme()">
                @if (settings.getEffectiveTheme() === 'dark') {
                <app-icon name="sun" [size]="18" />
                {{ i18n.t('settings.switchToLightMode') }}
                } @else {
                <app-icon name="moon" [size]="18" />
                {{ i18n.t('settings.switchToDarkMode') }}
                }
            </button>
        </div>


    </div>
</app-bottom-sheet>

<!-- Sign Out Confirmation Modal -->
<app-bottom-sheet [isOpen]="showSignOutConfirm()" [showDragHandle]="false" (closed)="showSignOutConfirm.set(false)">
    <div class="confirm-modal">
        <div class="confirm-icon">
            <app-icon name="log-out" [size]="32" />
        </div>
        <h3 class="confirm-title">{{ i18n.t('settings.signOutConfirmTitle') }}</h3>
        <p class="confirm-message">{{ i18n.t('settings.signOutConfirmMessage') }}</p>
        <div class="confirm-actions">
            <button class="confirm-btn confirm-btn--cancel" (click)="showSignOutConfirm.set(false)">
                {{ i18n.t('vocab.cancel') }}
            </button>
            <button class="confirm-btn confirm-btn--danger" (click)="confirmSignOut()">
                {{ i18n.t('header.signOut') }}
            </button>
        </div>
    </div>
</app-bottom-sheet>