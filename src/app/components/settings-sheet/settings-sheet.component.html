<app-bottom-sheet [isOpen]="isOpen()" [showCloseButton]="true" (closed)="onSheetClosed()">
    <div class="settings-sheet">
        <div class="settings-header">
            <h2>{{ i18n.t('settings.title') }}</h2>
        </div>

        <!-- User Section -->
        <div class="settings-section">
            @if (auth.isLoggedIn()) {
            <div class="user-card">
                <img [src]="auth.user()?.picture" [alt]="auth.user()?.name" class="user-avatar" />
                <div class="user-info">
                    <span class="user-name">{{ auth.user()?.name }}</span>
                    <span class="badge" [class]="'badge--' + auth.getSubscriptionTier()"
                        style="align-self: flex-start; margin-bottom: 2px;">
                        {{ auth.getSubscriptionTier() | uppercase }}
                    </span>
                    <span class="user-email">{{ auth.user()?.email }}</span>
                </div>
                <div class="sync-badge" [class.syncing]="sync.syncStatus() === 'syncing'"
                    [class.error]="sync.syncStatus() === 'error'">
                    @if (sync.syncStatus() === 'syncing') {
                    <app-icon name="loader" [size]="14" class="spin" />
                    } @else if (sync.syncStatus() === 'error') {
                    <app-icon name="alert-circle" [size]="14" />
                    } @else {
                    <app-icon name="check" [size]="14" />
                    }
                </div>
            </div>
            <button class="settings-btn settings-btn--danger" (click)="showSignOutModal()">
                <app-icon name="log-out" [size]="18" />
                {{ i18n.t('header.signOut') }}
            </button>
            } @else if (auth.isInitialized() && auth.isAuthEnabled()) {
            <button class="settings-btn settings-btn--primary" (click)="loginWithGoogle()" [disabled]="isLoggingIn">
                <app-icon name="user" [size]="18" />
                {{ i18n.t('header.signIn') }}
            </button>
            <p class="google-signin-hint">{{ i18n.t('settings.syncVocab') }}</p>
            }
        </div>

        <!-- Streak Section (Mobile Only) -->
        <div class="settings-section streak-section">
            <div class="setting-row streak-row">
                <div class="streak-icon-wrapper">
                    <app-icon name="fire" [size]="20" class="streak-icon" />
                </div>
                <div class="streak-info">
                    <span class="streak-count">{{ streak.currentStreak() }}</span>
                    <span class="streak-label">{{ i18n.t('streak.dayStreak') }}</span>
                </div>
                <div class="streak-meta">
                    <span class="streak-longest">{{ i18n.t('streak.longestStreak') }}: {{ streak.longestStreak()
                        }}</span>
                    @if (streak.freezesRemaining() > 0 && streak.currentStreak() > 0) {
                    <span class="streak-freezes-badge">
                        <app-icon name="snowflake" [size]="12" />
                        {{ streak.freezesRemaining() }}
                    </span>
                    }
                </div>
            </div>
        </div>

        <!-- Language Settings -->
        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.learningLanguage') }}</h3>
            <button class="setting-row setting-row--clickable" (click)="showLearningLangPicker.set(true)">
                <div class="setting-row__content">
                    <img [src]="currentLearningLang().flag" class="setting-row__flag" alt="" />
                    <span class="setting-row__value">{{ currentLearningLang().name }}</span>
                </div>
                <app-icon name="chevron-right" [size]="18" class="setting-row__chevron" />
            </button>
        </div>

        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.interfaceLanguage') }}</h3>
            <button class="setting-row setting-row--clickable" (click)="showUILangPicker.set(true)">
                <div class="setting-row__content">
                    <img [src]="currentUILang().flag" class="setting-row__flag" alt="" />
                    <span class="setting-row__value">{{ currentUILang().nativeName }}</span>
                </div>
                <app-icon name="chevron-right" [size]="18" class="setting-row__chevron" />
            </button>
        </div>

        <!-- Theme Toggle -->
        <div class="settings-section">
            <h3 class="section-title">{{ i18n.t('settings.appearance') }}</h3>
            <div class="setting-row">
                <div class="setting-row__content">
                    <app-icon [name]="isDarkMode() ? 'sun' : 'moon'" [size]="20" class="setting-row__icon" />
                    <span class="setting-row__label">
                        {{ isDarkMode() ? i18n.t('settings.switchToLightMode') : i18n.t('settings.switchToDarkMode') }}
                    </span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" [checked]="isDarkMode()" (change)="toggleTheme()" />
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
</app-bottom-sheet>

<!-- Learning Language Picker -->
<app-option-picker [options]="learningLangOptions()" [value]="settings.settings().language"
    [isOpen]="showLearningLangPicker()" [title]="i18n.t('settings.learningLanguage')"
    (selected)="onLearningLangSelected($event)" (closed)="showLearningLangPicker.set(false)" />

<!-- UI Language Picker -->
<app-option-picker [options]="uiLangOptions()" [value]="i18n.currentLanguage()" [isOpen]="showUILangPicker()"
    [title]="i18n.t('settings.interfaceLanguage')" (selected)="onUILangSelected($event)"
    (closed)="showUILangPicker.set(false)" />

<!-- Sign Out Confirmation -->
<app-confirm-dialog [isOpen]="showSignOutConfirm()" [title]="i18n.t('settings.signOutConfirmTitle')"
    [message]="i18n.t('settings.signOutConfirmMessage')" [confirmText]="i18n.t('header.signOut')"
    [cancelText]="i18n.t('vocab.cancel')" variant="danger" icon="log-out" (confirmed)="confirmSignOut()"
    (cancelled)="showSignOutConfirm.set(false)" />