<div class="subtitle-panel">
    @if (!isVideoFullscreen()) {
    <!-- Current subtitle -->
    <div class="current-subtitle" [class.current-subtitle--small]="settings.settings().fontSize === 'small'"
        [class.current-subtitle--large]="settings.settings().fontSize === 'large'"
        [class.is-generating]="transcript.isGeneratingAI()" [class.has-scroll-top]="hasScrollTop()">
        <div class="current-subtitle__inner" #currentSubtitleInner (scroll)="onCurrentSubtitleScroll()">
            @if (subtitles.currentCue(); as cue) {
            <!-- Centering wrapper - enables vertical centering for short content -->
            <div class="subtitle-center-wrapper">
                <div class="subtitle-text" [ngClass]="'text-' + settings.settings().language"
                    [class.is-looping]="isLoopEnabled()">
                    @if (currentTokens().length === 0) {
                    <!-- Shimmer skeleton while tokens load -->
                    <span class="token-loading">
                        @for (i of [1,2,3,4,5]; track $index) {
                        <span class="token-shimmer"></span>
                        }
                    </span>
                    } @else {
                    <span class="subtitle-content" @subtitleFade>
                        @for (token of currentTokens(); track $index) {@if (token.isPunctuation) {<span
                            class="punctuation">{{ token.surface }}</span>} @else {<span class="word"
                            [class.word--new]="token.level === 'new'"
                            [class.word--learning]="token.level === 'learning'"
                            [class.word--known]="token.level === 'known'"
                            [class.word--saved]="vocab.hasWord(token.surface)"
                            (click)="onWordClick(token, cue.text)">@if
                            (showReading() && getReading(token)) {<ruby>{{ token.surface }}<rt>{{ getReading(token) }}
                                </rt>
                            </ruby>} @else {{{ token.surface }}}</span>}}
                    </span>
                    }
                </div>
            </div>
            } @else {
            <div class="subtitle-empty">
                @if (youtube.currentVideo() && transcript.isGeneratingAI()) {
                <div class="ai-generating">
                    <div class="ai-badge">
                        <app-icon name="sparkles" [size]="16" />
                        <span>{{ i18n.t('subtitle.aiPowered') }}</span>
                    </div>
                    <div class="ai-spinner">
                        <div class="ai-spinner-ring"></div>
                        <app-icon name="wand" [size]="28" class="ai-wand" />
                    </div>
                    <p class="ai-title">{{ transcript.isResumingPendingJob() ? i18n.t('subtitle.resumingTranscript') :
                        i18n.t('subtitle.generatingTranscript') }}</p>
                    <p class="ai-hint">{{ transcript.isResumingPendingJob() ? i18n.t('subtitle.resumingHint') :
                        i18n.t('subtitle.usingWhisperAI') }}</p>
                </div>
                } @else if (youtube.currentVideo() && transcript.isLoading()) {
                <div class="loading-indicator">
                    <app-icon name="loader" [size]="24" />
                    <p>{{ i18n.t('subtitle.fetchingCaptions') }}</p>
                </div>
                } @else if (transcript.error() && subtitles.subtitles().length === 0) {
                <app-icon name="alert-circle" [size]="32" class="error-icon" />
                @if (transcript.error() === 'VIDEO_TOO_LONG') {
                <p class="empty-title">{{ i18n.t('subtitle.videoTooLongTitle') }}</p>
                <p class="empty-hint">{{ i18n.t('subtitle.videoTooLongHint') }}</p>
                } @else {
                <p class="empty-title">{{ i18n.t('subtitle.noSubtitlesAvailable') }}</p>
                <p class="empty-hint">{{ i18n.t('subtitle.aiUnavailable') }}</p>
                }
                } @else if (subtitles.subtitles().length === 0) {
                <app-icon name="subtitles" [size]="32" class="empty-icon" />
                <p class="empty-title">{{ i18n.t('subtitle.noSubtitlesLoaded') }}</p>
                <p class="empty-hint">{{ i18n.t('subtitle.tryVideoWithCaptions') }}</p>
                } @else {
                <p class="subtitle-waiting">{{ i18n.t('subtitle.waitingForSubtitles') }}</p>
                }
            </div>
            }
        </div>
    </div>

    <!-- Subtitle list (scrollable) -->
    @if (subtitles.subtitles().length > 0) {
    <div class="subtitle-list" #subtitleList>
        @for (cue of subtitles.subtitles(); track cue.id) {
        <button class="cue-item" [class.cue-item--active]="cue.id === subtitles.currentCue()?.id"
            [class.cue-item--past]="cue.endTime < youtube.currentTime()" [attr.data-cue-id]="cue.id"
            (click)="seekToCue(cue)">
            <span class="cue-time">{{ formatTime(cue.startTime) }}</span>
            <span class="cue-text">{{ cue.text }}</span>
        </button>
        }
    </div>
    }

    <!-- Controls -->
    <div class="subtitle-controls">
        <!-- Loop Toggle -->
        <button class="toggle-btn" [class.active]="isLoopEnabled()" (click)="toggleLoop()"
            [title]="i18n.t('subtitle.loop') + ' (L)'">
            <app-icon name="repeat" [size]="16" />
            <span>{{ i18n.t('subtitle.loop') }}</span>
            @if (isLoopEnabled() && loopCount() > 0) {
            <span class="toggle-btn__badge">{{ loopCount() }}/{{ maxLoops() }}</span>
            }
        </button>

        <!-- Reading Toggle -->
        <button class="toggle-btn" [class.active]="showReading()" (click)="toggleReading()"
            [title]="'Toggle ' + readingLabel()">
            <app-icon name="type" [size]="16" />
            <span>{{ readingLabel() }}</span>
        </button>

        <button class="toggle-btn added-btn" (click)="toggleAddedSheet()" [title]="i18n.t('nav.added')">
            <app-icon name="bookmark-plus" [size]="16" />
            @if (recentCount() > 0) {
            <span class="toggle-btn__badge">{{ recentCount() }}</span>
            }
        </button>

        <div class="font-controls">
            <button class="font-btn" [class.active]="settings.settings().fontSize === 'small'"
                (click)="settings.setFontSize('small')" [title]="i18n.t('subtitle.smallFont')">A</button>
            <button class="font-btn font-btn--medium" [class.active]="settings.settings().fontSize === 'medium'"
                (click)="settings.setFontSize('medium')" [title]="i18n.t('subtitle.mediumFont')">A</button>
            <button class="font-btn font-btn--large" [class.active]="settings.settings().fontSize === 'large'"
                (click)="settings.setFontSize('large')" [title]="i18n.t('subtitle.largeFont')">A</button>
        </div>
    </div>
    }
</div>

<!-- Vocabulary Quick View Sheet -->
<app-vocabulary-quick-view [isOpen]="showAddedSheet()" (closed)="showAddedSheet.set(false)" />